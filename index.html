<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—Ä–∞—á–∏ –∏ –ü—Ä–æ–¥–∞–∂–∏</title>
    <style>
        :root {
            --primary-color: #2d5f7f;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --light-gray: #ecf0f1;
            --dark-gray: #34495e;
            --border-color: #bdc3c7;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: var(--dark-gray);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-color) 0%, #1a3a52 100%);
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }

        .login-box h1 {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary-color);
            font-size: 28px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 16px;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(45, 95, 127, 0.1);
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #1e3f52;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(45, 95, 127, 0.3);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .error-message {
            color: var(--danger-color);
            text-align: center;
            margin-top: 15px;
            font-size: 14px;
        }

        /* Main App Screen */
        .app-screen {
            display: none;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: var(--primary-color);
            font-size: 24px;
        }

        .btn-logout {
            background-color: var(--danger-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-logout:hover {
            background-color: #c0392b;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .tab-btn {
            padding: 10px 20px;
            border: 2px solid var(--border-color);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
        }

        .tab-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .tab-btn:hover {
            border-color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Sales Form */
        .sales-form {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 16px;
        }

        .search-results {
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: white;
        }

        .doctor-item {
            padding: 12px 15px;
            border-bottom: 1px solid var(--light-gray);
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 14px;
        }

        .doctor-item:hover {
            background-color: var(--light-gray);
        }

        .doctor-item.selected {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
        }

        .selected-doctor {
            background: var(--light-gray);
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .selected-doctor strong {
            color: var(--primary-color);
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .product-btn {
            padding: 15px;
            border: 2px solid var(--border-color);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
            text-align: center;
        }

        .product-btn:hover {
            border-color: var(--primary-color);
            background-color: var(--light-gray);
        }

        .product-btn.selected {
            background-color: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
        }

        .btn-success:hover {
            background-color: #229954;
        }

        .btn-success:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }

        .btn-cancel {
            background-color: #95a5a6;
            color: white;
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
        }

        .btn-cancel:hover {
            background-color: #7f8c8d;
        }

        /* Reports */
        .report-section {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .report-section h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 18px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .report-table th {
            background-color: var(--primary-color);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .report-table td {
            padding: 12px;
            border-bottom: 1px solid var(--light-gray);
        }

        .report-table tr:hover {
            background-color: var(--light-gray);
        }

        /* Admin Panel */
        .admin-form {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .admin-form h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 16px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row.full {
            grid-template-columns: 1fr;
        }

        .admin-form input, .admin-form select {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
        }

        .admin-form input:focus, .admin-form select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .success-message {
            background-color: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
            font-size: 14px;
        }

        .success-message.show {
            display: block;
        }

        .doctors-list {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            max-height: 400px;
            overflow-y: auto;
        }

        .doctor-row {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr auto;
            gap: 10px;
            padding: 12px 15px;
            border-bottom: 1px solid var(--light-gray);
            align-items: center;
            font-size: 14px;
        }

        .doctor-row:hover {
            background-color: var(--light-gray);
        }

        .btn-edit {
            background-color: var(--warning-color);
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }

        .btn-edit:hover {
            background-color: #e67e22;
        }

        .btn-delete {
            background-color: var(--danger-color);
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }

        .btn-delete:hover {
            background-color: #c0392b;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .products-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .doctor-row {
                grid-template-columns: 1fr;
                gap: 5px;
            }

            .report-table th, .report-table td {
                padding: 8px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <h1>üè• –í—Ä–∞—á–∏ –∏ –ü—Ä–æ–¥–∞–∂–∏</h1>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">–õ–æ–≥–∏–Ω:</label>
                    <input type="text" id="username" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω" required>
                </div>
                <div class="form-group">
                    <label for="password">–ü–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" required>
                </div>
                <button type="submit" class="btn btn-primary">–í—Ö–æ–¥</button>
                <div id="loginError" class="error-message"></div>
            </form>
        </div>
    </div>

    <!-- App Screen -->
    <div id="appScreen" class="app-screen">
        <div class="container">
            <div class="header">
                <h1>üè• –í—Ä–∞—á–∏ –∏ –ü—Ä–æ–¥–∞–∂–∏</h1>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span id="userRole" style="font-weight: 600;"></span>
                    <button class="btn-logout" onclick="logout()">–í—ã—Ö–æ–¥</button>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs" id="userTabs"></div>

            <!-- Sales Tab -->
            <div id="salesTab" class="tab-content">
                <div class="sales-form">
                    <h2 style="color: var(--primary-color); margin-bottom: 20px;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ–¥–∞–∂–∏</h2>
                    
                    <div class="search-box">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">–ü–æ–∏—Å–∫ –≤—Ä–∞—á–∞ (–∫–æ–¥ –∏–ª–∏ —Ñ–∞–º–∏–ª–∏—è):</label>
                        <input type="text" id="doctorSearch" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–ª–∏ –ø–µ—Ä–≤—ã–µ –±—É–∫–≤—ã —Ñ–∞–º–∏–ª–∏–∏...">
                        <div id="searchResults" class="search-results"></div>
                    </div>

                    <div id="selectedDoctor" class="selected-doctor" style="display: none;">
                        –í—ã–±—Ä–∞–Ω–Ω—ã–π –≤—Ä–∞—á: <strong id="selectedDoctorName"></strong> (–∫–æ–¥: <span id="selectedDoctorCode"></span>)
                    </div>

                    <label style="display: block; margin: 20px 0 10px; font-weight: 600;">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä:</label>
                    <div class="products-grid">
                        <button class="product-btn" data-product="–æ–±—É–≤—å" onclick="selectProduct(this)">üëü –û–±—É–≤—å</button>
                        <button class="product-btn" data-product="—Å—Ç–µ–ª—å–∫–∏" onclick="selectProduct(this)">üìç –°—Ç–µ–ª—å–∫–∏</button>
                        <button class="product-btn" data-product="–∞–∫—Å–µ—Å—Å—É–∞—Ä—ã" onclick="selectProduct(this)">üéí –ê–∫—Å–µ—Å—Å—É–∞—Ä—ã</button>
                        <button class="product-btn" data-product="—Å—É–ø–∏–Ω–∞—Ç–æ—Ä" onclick="selectProduct(this)">ü¶∂ –°—É–ø–∏–Ω–∞—Ç–æ—Ä</button>
                        <button class="product-btn" data-product="–±—Ä–µ–π—Å" onclick="selectProduct(this)">üè• –ë—Ä–µ–π—Å</button>
                        <button class="product-btn" data-product="—á—É–ª–∫–∏" onclick="selectProduct(this)">üß¶ –ß—É–ª–∫–∏</button>
                        <button class="product-btn" data-product="—à–∏–Ω–∞ —Ñ—Ä–µ–π–∫–∞" onclick="selectProduct(this)">üîß –®–∏–Ω–∞ —Ñ—Ä–µ–π–∫–∞</button>
                    </div>

                    <div class="action-buttons">
                        <button class="btn-success" onclick="recordSale()" id="saveSaleBtn" disabled>‚úì –ó–∞–ø–∏—Å–∞—Ç—å –ø—Ä–æ–¥–∞–∂—É</button>
                        <button class="btn-cancel" onclick="resetForm()">‚úï –û—á–∏—Å—Ç–∏—Ç—å</button>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reportsTab" class="tab-content" style="display: none !important;">
                <div class="report-section">
                    <h2>–ü—Ä–æ–¥–∞–∂–∏ –∑–∞ 15 –¥–Ω–µ–π</h2>
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>–í—Ä–∞—á</th>
                                <th>–ö–æ–¥</th>
                                <th>–¢–æ–≤–∞—Ä</th>
                                <th>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</th>
                            </tr>
                        </thead>
                        <tbody id="report15">
                            <tr><td colspan="4" style="text-align: center; color: #999;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="report-section">
                    <h2>–ü—Ä–æ–¥–∞–∂–∏ –∑–∞ –º–µ—Å—è—Ü</h2>
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>–í—Ä–∞—á</th>
                                <th>–û–±—É–≤—å</th>
                                <th>–°—Ç–µ–ª—å–∫–∏</th>
                                <th>–°—É–ø–∏–Ω–∞—Ç–æ—Ä—ã</th>
                                <th>–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã</th>
                                <th>–ë—Ä–µ–π—Å—ã</th>
                                <th>–ß—É–ª–∫–∏</th>
                                <th>–®–∏–Ω—ã —Ñ—Ä–µ–π–∫–∞</th>
                                <th>–í—Å–µ–≥–æ</th>
                            </tr>
                        </thead>
                        <tbody id="reportMonth">
                            <tr><td colspan="9" style="text-align: center; color: #999;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Admin Panel Tab -->
            <div id="adminTab" class="tab-content">
                <div class="admin-form">
                    <h3>‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –≤—Ä–∞—á–∞</h3>
                    <div id="successMsg" class="success-message"></div>
                    <div class="form-row">
                        <input type="text" id="newDoctorCode" placeholder="–ö–æ–¥ –≤—Ä–∞—á–∞" maxlength="10">
                        <input type="text" id="newDoctorName" placeholder="–§–∞–º–∏–ª–∏—è –∏ –∏–º—è">
                    </div>
                    <button class="btn btn-primary" onclick="addDoctor()" style="width: 100%;">–î–æ–±–∞–≤–∏—Ç—å –≤—Ä–∞—á–∞</button>
                </div>

                <div class="report-section">
                    <h2>–°–ø–∏—Å–æ–∫ –≤—Ä–∞—á–µ–π</h2>
                    <div class="doctors-list">
                        <div style="padding: 12px 15px; text-align: center; color: #999;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const SUPABASE_URL = 'https://mvjiqysmcclvceswfqwv.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12amlxeXNtY2NsdmNlc3dmcXd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MDUyOTYsImV4cCI6MjA3Njk4MTI5Nn0.FoRyIZ9E4M2ZwEE8Kh4hDdkBDLuhyqRut7VEKG4uQkk';

        // State
        let currentUser = null;
        let doctors = [];
        let selectedDoctor = null;
        let selectedProduct = null;

        // Initialize
        document.getElementById('loginForm').addEventListener('submit', handleLogin);
        document.getElementById('doctorSearch').addEventListener('input', searchDoctors);

        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            let role = null;
            if (username === 'sale' && password === '1234') {
                role = 'seller';
            } else if (username === 'admin' && password === 'admin123') {
                role = 'admin';
            } else {
                document.getElementById('loginError').textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å';
                return;
            }

            currentUser = { username, role };
            showAppScreen();
            loadDoctors();
            setupTabs();
        }

        function setupTabs() {
            const tabsContainer = document.getElementById('userTabs');
            tabsContainer.innerHTML = '';

            if (currentUser.role === 'seller') {
                document.getElementById('userRole').textContent = 'üë§ –ü—Ä–æ–¥–∞–≤–µ—Ü';
                tabsContainer.innerHTML = `
                    <button class="tab-btn active" onclick="switchTab('salesTab')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ–¥–∞–∂–∏</button>
                    <button class="tab-btn" onclick="switchTab('reportsTab')" style="display: none;">–û—Ç—á–µ—Ç—ã</button>
                `;
            } else {
                document.getElementById('userRole').textContent = 'üë®‚Äçüíº –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä';
                tabsContainer.innerHTML = `
                    <button class="tab-btn active" onclick="switchTab('salesTab')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ–¥–∞–∂–∏</button>
                    <button class="tab-btn" onclick="switchTab('reportsTab')" style="display: none;">–û—Ç—á–µ—Ç—ã</button>
                    <button class="tab-btn" onclick="switchTab('adminTab')">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Ä–∞—á–∞–º–∏</button>
                `;
            }

            document.querySelector('.tab-btn').click();
        }

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'reportsTab') {
                loadReports();
            } else if (tabName === 'adminTab') {
                loadDoctorsList();
            }
        }

        async function loadDoctors() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/doctors?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });

                if (response.ok) {
                    doctors = await response.json();
                } else {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤—Ä–∞—á–µ–π');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function searchDoctors(e) {
            const query = e.target.value.toLowerCase();
            const resultsDiv = document.getElementById('searchResults');

            if (!query) {
                resultsDiv.innerHTML = '';
                return;
            }

            const filtered = doctors.filter(d => 
                d.code.toLowerCase().includes(query) ||
                d.name.toLowerCase().includes(query)
            ).slice(0, 10);

            resultsDiv.innerHTML = filtered.map(d => 
                `<div class="doctor-item" onclick="selectDoctor(${d.id}, '${d.name}', '${d.code}')">
                    ${d.code} - ${d.name}
                </div>`
            ).join('');
        }

        function selectDoctor(id, name, code) {
            selectedDoctor = { id, name, code };
            document.getElementById('doctorSearch').value = '';
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('selectedDoctor').style.display = 'block';
            document.getElementById('selectedDoctorName').textContent = name;
            document.getElementById('selectedDoctorCode').textContent = code;
            updateSaveButton();
        }

        function selectProduct(btn) {
            document.querySelectorAll('.product-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedProduct = btn.dataset.product;
            updateSaveButton();
        }

        function updateSaveButton() {
            const btn = document.getElementById('saveSaleBtn');
            btn.disabled = !(selectedDoctor && selectedProduct);
        }

        async function recordSale() {
            if (!selectedDoctor || !selectedProduct) return;

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/sales`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        doctor_id: selectedDoctor.id,
                        product_type: selectedProduct
                    })
                });

                if (response.ok) {
                    alert('‚úì –ü—Ä–æ–¥–∞–∂–∞ –∑–∞–ø–∏—Å–∞–Ω–∞!');
                    resetForm();
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ –ø—Ä–æ–¥–∞–∂–∏');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        function resetForm() {
            selectedDoctor = null;
            selectedProduct = null;
            document.getElementById('doctorSearch').value = '';
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('selectedDoctor').style.display = 'none';
            document.querySelectorAll('.product-btn').forEach(b => b.classList.remove('selected'));
            updateSaveButton();
        }

        async function loadReports() {
            try {
                // 15-day report
                const date15 = new Date();
                date15.setDate(date15.getDate() - 15);
                
                const response15 = await fetch(
                    `${SUPABASE_URL}/rest/v1/sales?select=*,doctors(id,name,code)&sale_date=gte.${date15.toISOString()}&order=sale_date.desc`,
                    {
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`
                        }
                    }
                );

                if (response15.ok) {
                    const sales15 = await response15.json();
                    const html15 = sales15.length ? sales15.map(s => `
                        <tr>
                            <td>${s.doctors?.name || 'N/A'}</td>
                            <td>${s.doctors?.code || 'N/A'}</td>
                            <td>${s.product_type}</td>
                            <td>${new Date(s.sale_date).toLocaleString('ru-RU')}</td>
                        </tr>
                    `).join('') : '<tr><td colspan="4" style="text-align: center; color: #999;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
                    
                    document.getElementById('report15').innerHTML = html15;
                }

                // Month report
                const dateMonth = new Date();
                dateMonth.setMonth(dateMonth.getMonth() - 1);
                
                const responseMonth = await fetch(
                    `${SUPABASE_URL}/rest/v1/sales?select=*,doctors(id,name,code)&sale_date=gte.${dateMonth.toISOString()}&order=doctors(name)`,
                    {
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`
                        }
                    }
                );

                if (responseMonth.ok) {
                    const salesMonth = await responseMonth.json();
                    const grouped = {};
                    
                    salesMonth.forEach(s => {
                        const key = s.doctors?.name || 'Unknown';
                        if (!grouped[key]) {
                            grouped[key] = { –æ–±—É–≤—å: 0, —Å—Ç–µ–ª—å–∫–∏: 0, —Å—É–ø–∏–Ω–∞—Ç–æ—Ä—ã: 0, –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã: 0, –±—Ä–µ–π—Å—ã: 0, —á—É–ª–∫–∏: 0, '—à–∏–Ω–∞ —Ñ—Ä–µ–π–∫–∞': 0 };
                        }
                        grouped[key][s.product_type] = (grouped[key][s.product_type] || 0) + 1;
                    });

                    const htmlMonth = Object.entries(grouped).map(([name, products]) => {
                        const total = Object.values(products).reduce((a, b) => a + b, 0);
                        return `
                            <tr>
                                <td><strong>${name}</strong></td>
                                <td>${products.–æ–±—É–≤—å || 0}</td>
                                <td>${products.—Å—Ç–µ–ª—å–∫–∏ || 0}</td>
                                <td>${products.—Å—É–ø–∏–Ω–∞—Ç–æ—Ä—ã || 0}</td>
                                <td>${products.–∞–∫—Å–µ—Å—Å—É–∞—Ä—ã || 0}</td>
                                <td>${products.–±—Ä–µ–π—Å—ã || 0}</td>
                                <td>${products.—á—É–ª–∫–∏ || 0}</td>
                                <td>${products['—à–∏–Ω–∞ —Ñ—Ä–µ–π–∫–∞'] || 0}</td>
                                <td><strong>${total}</strong></td>
                            </tr>
                        `;
                    }).join('') || '<tr><td colspan="9" style="text-align: center; color: #999;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
                    
                    document.getElementById('reportMonth').innerHTML = htmlMonth;
                }
            } catch (error) {
                console.error('Error loading reports:', error);
            }
        }

        async function addDoctor() {
            const code = document.getElementById('newDoctorCode').value.trim();
            const name = document.getElementById('newDoctorName').value.trim();

            if (!code || !name) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/doctors`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ code, name })
                });

                if (response.ok) {
                    showSuccessMsg('‚úì –í—Ä–∞—á –¥–æ–±–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
                    document.getElementById('newDoctorCode').value = '';
                    document.getElementById('newDoctorName').value = '';
                    loadDoctors();
                    loadDoctorsList();
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤—Ä–∞—á–∞');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        async function loadDoctorsList() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/doctors?order=name`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });

                if (response.ok) {
                    const doctorsList = await response.json();
                    const html = doctorsList.map(d => `
                        <div class="doctor-row">
                            <div>${d.code}</div>
                            <div>${d.name}</div>
                            <div>${new Date(d.created_at).toLocaleDateString('ru-RU')}</div>
                            <div>
                                <button class="btn-delete" onclick="deleteDoctor(${d.id})">‚úï –£–¥–∞–ª–∏—Ç—å</button>
                            </div>
                        </div>
                    `).join('');

                    document.querySelector('.doctors-list').innerHTML = html || '<div style="padding: 12px 15px; text-align: center; color: #999;">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</div>';
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function deleteDoctor(id) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã?')) return;

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/doctors?id=eq.${id}`, {
                    method: 'DELETE',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });

                if (response.ok) {
                    loadDoctors();
                    loadDoctorsList();
                    showSuccessMsg('‚úì –í—Ä–∞—á —É–¥–∞–ª–µ–Ω!');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function showSuccessMsg(msg) {
            const msgEl = document.getElementById('successMsg');
            msgEl.textContent = msg;
            msgEl.classList.add('show');
            setTimeout(() => msgEl.classList.remove('show'), 3000);
        }

        function showAppScreen() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appScreen').style.display = 'block';
        }

        function logout() {
            currentUser = null;
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('appScreen').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginError').textContent = '';
        }
    </script>
</body>
</html>
